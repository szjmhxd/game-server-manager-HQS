{% extends "layout.html" %}

{% block content %}
<h1>用户配置文件权限管理</h1>
{% with messages = get_flashed_messages() %}
{% if messages %}
<ul>
  {% for message in messages %}
  <li>{{ message }}</li>
  {% endfor %}
</ul>
{% endif %}
{% endwith %}
<form method="post">
  <label>选择用户：</label>
  <select name="user_id" id="user_id">
    {% for user in users %}
    <option value="{{ user[0] }}" {% if user[0]==selected_user_id %}selected{% endif %}>{{ user[1] }}</option>
    {% endfor %}
  </select>
  <button type="submit" name="action" value="switch">切换用户</button>
  <br><br>
  
  {% if selected_user_id %}
  <!-- 当前选中用户的修改权限设置 -->
  <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
    <h3>用户修改权限设置</h3>
    {% for user in users %}
      {% if user[0] == selected_user_id %}
      <div style="margin-bottom: 10px;">
        <label style="display: inline-block; width: 100px;">{{ user[1] }}:</label>
        <select name="permission">
          <option value="0" {% if user.permission == 0 %}selected{% endif %}>无权限</option>
          <option value="1" {% if user.permission == 1 %}selected{% endif %}>有权限</option>
        </select>
        <input type="hidden" name="current_user_id" value="{{ selected_user_id }}">
      </div>
      {% endif %}
    {% endfor %}
  </div>
  
  <!-- 配置文件访问权限 -->
  <div style="border: 1px solid #ccc; padding: 10px;">
    <h3>可访问的配置文件</h3>
    {% for cf in config_files %}
    <input type="checkbox" name="config_file_ids" value="{{ cf[0] }}" {% if cf[0] in
      (user_permissions.get(selected_user_id) or []) %}checked{% endif %}>
    {{ cf[1] }} <!-- 显示配置文件名称 -->
    <br>
    {% endfor %}
  </div>
  
  <br>
  <button type="submit" name="action" value="save_all">保存所有权限设置</button>
  {% endif %}
</form>
{% endblock %}